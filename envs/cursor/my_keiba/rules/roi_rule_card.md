# ROI計算ルールカード

## 基本方針
**TARGET frontier基準の検証可能な入力を作り、壊れないROIだけ出す**

## 用語の正体

### ZI_Index
- **正体**: 能力指数（印）。スケール60〜80（平均70前後）
- **扱い**: スコア/特徴量（順位化・標準化OK）。**ROI計算に混入禁止**
- **用途**: 学習・特徴量のみ

### ZM_Value
- **正体**: 予想単勝オッズの近似値。整数で10倍表記（例：29 → 2.9倍）
- **変換**: `zm_odds_pred = ZM_Value / 10.0`（倍率）
- **扱い**: 予想側特徴（人気proxy）。**実ROI計算には使わない**
- **用途**: 学習・特徴量のみ

## ROI計算の固定ルール

### 使用列（固定・3列のみ）
```
finish / win_pay_yen / plc_pay_yen_low
```

### 禁止列
- ZI_Index（指数）
- ZM_Value（予想オッズproxy）
- win_odds / plc_odds_low（倍率系）

### 計算方法

#### 単勝（全頭100円購入）
```
購入額 = 出走頭数 × 100円
払戻額 = 的中馬（finish=1）の単勝払戻金（円）の合計
回収率(%) = 100 × 払戻額 / 購入額
```

#### 複勝（全頭100円・下限で概算）
```
購入額 = 出走頭数 × 100円
払戻額 = 的中馬（1〜3着）の複勝払戻金（円）の合計
回収率(%) = 100 × 払戻額 / 購入額
```

## 現実レンジ（サニティチェック）

### 正常範囲
- **単勝**: 75〜85%（長期平均）
- **複勝**: 80〜90%（長期平均）

### 異常検知範囲
- **単勝**: 30〜130% を超えたら異常
- **複勝**: 40〜160% を超えたら異常

## 無限ループ回避ルール

### 1. ROI入力はV_ROI_INPUT（3列固定）だけ
### 2. レンジ監査：異常範囲でFAIL停止（再判定しない）
### 3. ZI/ZMは学習用だけ（SE_FEでzscore/順位化）
### 4. 監査ログに「どの列を使ったか（3列のみ）」を毎回記録

## トラブルシューティング

### 単勝ROIが跳ねる場合
V_ROI_INPUTの10行を確認：
```sql
SELECT race_id, horse_id, finish, win_pay_yen, plc_pay_yen_low
FROM V_ROI_INPUT
LIMIT 10
```

### チェックポイント
- 円でない値が混入していないか
- finish≠1なのにwin_pay_yenに入っているか
- 異常な値（10,000円超等）が混入していないか

## オッズ計算の基本
- オッズ2.1なら2.1倍
- 100円購入で払い戻しは210円

---
**重要**: このルールを破ると無限ループが発生します。必ず守ってください。
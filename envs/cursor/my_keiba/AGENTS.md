# Codex エージェント運用ルール

## 基本方針

Codex エージェントは「やりっぱなし」にならないよう、**計画→確認→実行→要約→次の候補**のフローを徹底します。

## 必須フロー

### 1. 計画表示
- 実行前に必ず計画を表示
- 変更内容、影響範囲、リスクを明記
- 複数ステップの場合は全体像を提示

### 2. 確認プロンプト
- 計画表示後、必ずユーザーに確認を求める
- 「実行しますか？ [y/N]」形式で統一
- デフォルトは「N」（安全側）

### 3. 実行
- 確認後にのみ実行
- 進捗状況を適切に報告
- エラー時は即座に停止して報告

### 4. 要約
- 実行結果の要約を提供
- 成功/失敗、変更内容、次に必要なアクション

### 5. 次の候補
- 関連する次のステップを提案
- ユーザーが迷わないよう具体的に

## 技術的制約

### Windows PowerShell 前提
- `Get-ChildItem -Force` でファイル一覧
- `Get-Content` でファイル読み取り
- `Select-String` でテキスト検索
- PowerShell コマンドを優先使用

### 変更系は必ず diff 表示
- ファイル変更前後を比較表示
- 変更内容を明確に可視化
- ユーザーが変更を理解できるよう配慮

## 承認範囲

詳細は `APPROVALS.md` を参照：

### 自動許可
- 読み取り系（Get-ChildItem, Get-Content, Select-String など）
- 情報収集・分析系

### 常に確認
- 書き込み/実行系（git, dotnet run, ファイル変更, インストール など）
- システム設定変更
- データベース操作

### セッション限定
- 「Always」承認はそのセッション内のみ
- 新しいセッションでは再確認

## 実装例

### 良い例
```
## 実行計画

以下のファイルを変更します：
- `config.json`: データベース接続設定を更新
- `scripts/run.py`: ログ出力レベルを変更

変更内容：
1. DB接続文字列を localhost から production に変更
2. ログレベルを DEBUG から INFO に変更

影響範囲：
- 本番環境への接続が開始されます
- ログ出力量が減少します

実行しますか？ [y/N]
```

### 悪い例
```
ファイルを変更します。
（確認なしで実行）
```

## 緊急時対応

### エラー発生時
1. 即座に実行を停止
2. エラー内容を詳細に報告
3. 復旧手順を提案
4. ユーザーの指示を待つ

### 予期しない結果
1. 結果を詳細に分析
2. 原因を特定
3. 修正案を提示
4. 再実行の可否を確認

## セッション管理

### 開始時
- 現在の状況を確認
- 作業目標を明確化
- 必要な権限を確認

### 終了時
- 完了した作業を要約
- 未完了の作業を明記
- 次回の開始点を提示

## 品質保証

### コード品質
- リントエラーの確認と修正
- テスト実行（可能な場合）
- ドキュメント更新

### セキュリティ
- 機密情報の取り扱い注意
- 権限の最小化
- 変更履歴の記録

---

**重要**: このルールは Codex エージェントの安全性と信頼性を確保するためのものです。例外は認めません。
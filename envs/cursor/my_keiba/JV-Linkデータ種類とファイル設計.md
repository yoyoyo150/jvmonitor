# JV-Linkデータ種類とファイル設計

## 1. JV-Linkデータ種類の全体像

### 1.1 主要データ種類（JVData_Structure.vbより）

| データ種類 | 構造体名 | 説明 | ファイル拡張子 |
|------------|----------|------|----------------|
| **RA** | JV_RA_RACE | レース基本情報 | .jvd |
| **SE** | JV_SE_RACE_UMA | レース結果・馬情報 | .jvd |
| **HR** | JV_HR_PAY | 払戻金情報 | .jvd |
| **H1** | JV_H1_HYOSU_ZENKAKE | 全賭式票数 | .jvd |
| **H6** | JV_H6_HYOSU_SANRENTAN | 三連単票数 | .jvd |
| **O1** | JV_O1_ODDS_TANFUKUWAKU | 単勝・複勝・馬連オッズ | .jvd |
| **O2** | JV_O2_ODDS_UMAREN | 馬連オッズ | .jvd |
| **O3** | JV_O3_ODDS_WIDE | ワイドオッズ | .jvd |
| **O4** | JV_O4_ODDS_UMATAN | 馬単オッズ | .jvd |
| **O5** | JV_O5_ODDS_SANREN | 三連複オッズ | .jvd |
| **O6** | JV_O6_ODDS_SANRENTAN | 三連単オッズ | .jvd |
| **UM** | JV_UM_UMA | 馬基本情報 | .jvd |
| **KS** | JV_KS_KISYU | 騎手情報 | .jvd |
| **CH** | JV_CH_CHOKYOSI | 調教師情報 | .jvd |
| **BR** | JV_BR_BREEDER | 生産者情報 | .jvd |
| **BN** | JV_BN_BANUSI | 馬主情報 | .jvd |
| **HN** | JV_HN_HANSYOKU | 繁殖情報 | .jvd |
| **SK** | JV_SK_SANKU | 産駒情報 | .jvd |
| **RC** | JV_RC_RECORD | レコード情報 | .jvd |
| **HC** | JV_HC_HANRO | 坂路調教データ | .jvd |
| **WC** | JV_WC_WOOD | ウッドチップ調教データ | .jvd |
| **JG** | JV_JG_JOGAIBA | 除外情報 | .jvd |
| **WF** | JV_WF_INFO | ワイドファンファーレ情報 | .jvd |

### 1.2 ファイル命名規則

JV-Linkのファイル名は以下の形式で命名されます：
```
[データ種類][競馬場コード][年月日][作成時刻].jvd
```

例：
- `RAPW2025072020250717161413.jvd` = レースデータ(RA) + 阪神(PW) + 2025年7月20日 + 作成時刻
- `SEPW2025072020250717183726.jvd` = レース結果(SE) + 阪神(PW) + 2025年7月20日 + 作成時刻
- `JGDW2025071920250718112858.jvd` = 除外情報(JG) + 東京(DW) + 2025年7月19日 + 作成時刻

## 2. データ種類別の詳細分析

### 2.1 レース関連データ（競馬開催日ごと）

| データ種類 | 内容 | 件数 | 関連性 |
|------------|------|------|--------|
| **RA** | レース基本情報 | 12レース/日 | 各レースの基本情報 |
| **SE** | レース結果・馬情報 | 12レース×出走頭数/日 | 各レースの結果と出走馬情報 |
| **HR** | 払戻金情報 | 12レース×賭式数/日 | 各レースの払戻金 |
| **H1** | 全賭式票数 | 12レース×賭式数/日 | 各レースの投票数 |
| **H6** | 三連単票数 | 12レース/日 | 各レースの三連単投票数 |
| **O1-O6** | 各種オッズ | 12レース×賭式数/日 | 各レースのオッズ情報 |

### 2.2 調教データ（毎日更新）

| データ種類 | 内容 | 件数 | 更新頻度 |
|------------|------|------|----------|
| **HC** | 坂路調教データ | 変動 | 毎日 |
| **WC** | ウッドチップ調教データ | 変動 | 毎日 |

### 2.3 除外情報（毎日更新）

| データ種類 | 内容 | 件数 | 更新頻度 |
|------------|------|------|----------|
| **JG** | 除外情報 | 変動 | 毎日 |

### 2.4 基本情報（不定期更新）

| データ種類 | 内容 | 件数 | 更新頻度 |
|------------|------|------|----------|
| **UM** | 馬基本情報 | 全登録馬 | 新馬登録時 |
| **KS** | 騎手情報 | 全騎手 | 新規登録時 |
| **CH** | 調教師情報 | 全調教師 | 新規登録時 |
| **BR** | 生産者情報 | 全生産者 | 新規登録時 |
| **BN** | 馬主情報 | 全馬主 | 新規登録時 |

## 3. 1つのCSVファイルでの統合設計

### 3.1 統合CSVファイル構造

```csv
データ種類,年,月日,競馬場コード,競馬場名,回次,日次,レース番号,馬番,血統番号,馬名,レース名,距離,トラック,天候,馬場,着順,タイム,着差,通過順,上がり3F,上がり4F,単勝オッズ,複勝オッズ,馬連オッズ,馬単オッズ,三連複オッズ,三連単オッズ,単勝人気,複勝人気,馬連人気,馬単人気,三連複人気,三連単人気,騎手名,調教師名,馬主名,生産者名,調教タイプ,調教日,調教時刻,調教タイム,除外理由,除外状態,作成日時
```

### 3.2 データ種類別のマッピング

#### レース基本情報（RA）
```csv
RA,2025,0720,08,京都,01,01,01,,,,,芝2000,良,晴,良,,,,,,,,,,,,,,,,,,,,,,,,,2025-07-20 16:14:13
```

#### レース結果・馬情報（SE）
```csv
SE,2025,0720,08,京都,01,01,01,01,1234567890,ディープインパクト,芝2000,芝2000,良,晴,良,1,2:00.5,0.0,1-1-1,34.5,46.2,3.2,1.8,12.5,15.2,120.5,350.2,1,1,1,1,1,1,武豊,池江泰郎,金子真人,社台レースホース,,,,,,2025-07-20 18:37:26
```

#### 調教データ（HC/WC）
```csv
HC,2025,0720,08,京都,,,,,,,,,,,,,,,,,,,,,,,,,,,坂路,2025-07-20,08:30,51.2,,,,2025-07-20 11:28:58
WC,2025,0720,08,京都,,,,,,,,,,,,,,,,,,,,,,,,,,,ウッド,2025-07-20,09:15,50.8,,,,2025-07-20 11:28:59
```

#### 除外情報（JG）
```csv
JG,2025,0720,08,京都,01,01,01,01,1234567890,ディープインパクト,,,,,,,,,,,,,,,,,,,,,,,,,,,発走除外,発走除外,,,2025-07-20 11:28:58
```

### 3.3 統合処理ロジック

#### 3.3.1 データ統合の流れ
1. **基本情報の取得**: RAデータをベースとして基本情報を設定
2. **結果情報の統合**: SEデータでレース結果を追加
3. **調教情報の統合**: HC/WCデータで調教情報を追加
4. **除外情報の統合**: JGデータで除外情報を追加
5. **オッズ情報の統合**: O1-O6データでオッズ情報を追加

#### 3.3.2 ユニークキーの設計
```
ユニークキー = データ種類 + 年 + 月日 + 競馬場コード + 回次 + 日次 + レース番号 + 馬番
```

#### 3.3.3 重複対策
- **同一キーの場合**: 最新データで上書き
- **データ種類が異なる場合**: 別レコードとして追加
- **部分更新**: 既存レコードの特定フィールドのみ更新

## 4. 実装方針

### 4.1 段階的実装

#### Phase 1: 基本データ統合
- RA（レース基本情報）
- SE（レース結果・馬情報）
- 基本的なCSV出力

#### Phase 2: 調教データ統合
- HC（坂路調教データ）
- WC（ウッドチップ調教データ）
- 調教情報の統合

#### Phase 3: 除外情報統合
- JG（除外情報）
- 除外状態の統合

#### Phase 4: オッズ情報統合
- O1-O6（各種オッズ）
- オッズ情報の統合

#### Phase 5: 基本情報統合
- UM（馬基本情報）
- KS（騎手情報）
- CH（調教師情報）
- 基本情報の統合

### 4.2 ファイル管理戦略

#### 4.2.1 日次ファイル分割
```
race_data_20250720.csv  # 2025年7月20日のデータ
race_data_20250721.csv  # 2025年7月21日のデータ
```

#### 4.2.2 月次ファイル統合
```
race_data_202507.csv    # 2025年7月の全データ
```

#### 4.2.3 年次ファイル統合
```
race_data_2025.csv      # 2025年の全データ
```

### 4.3 パフォーマンス最適化

#### 4.3.1 メモリ効率
- ストリーミング処理による大容量データ対応
- バッチ処理による段階的統合

#### 4.3.2 処理速度
- インデックス付きCSVファイル
- 並列処理による高速化

#### 4.3.3 ストレージ効率
- 圧縮CSVファイル
- 差分更新による容量削減

## 5. 期待される結果

### 5.1 データ統合後の利点
- **一元管理**: 1つのCSVファイルで全データを管理
- **分析効率**: データ分析が容易
- **可視化**: 統合データによる高度な可視化
- **機械学習**: 統合データによるMLモデル構築

### 5.2 ファイル数の削減
- **従来**: 70以上の.jvdファイル
- **統合後**: 1つのCSVファイル（日次）
- **削減率**: 約99%のファイル数削減

### 5.3 データ品質の向上
- **整合性**: データ間の整合性確保
- **完全性**: 欠損データの補完
- **正確性**: 重複データの排除

## 6. 実装スケジュール

### Week 1: 基本設計
- データ構造の詳細設計
- CSVスキーマの確定
- 統合ロジックの設計

### Week 2: Phase 1実装
- RA/SEデータ統合
- 基本CSV出力機能

### Week 3: Phase 2実装
- HC/WCデータ統合
- 調教情報統合

### Week 4: Phase 3実装
- JGデータ統合
- 除外情報統合

### Week 5: テスト・最適化
- 全データ統合テスト
- パフォーマンス最適化
- ドキュメント整備

---

この設計により、JV-Linkの70以上のデータファイルを1つの統合CSVファイルに統合し、効率的なデータ管理と分析が可能になります。 